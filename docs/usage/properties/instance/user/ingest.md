## Ingest

The following properties relate to standard ingest.

| Property Name                                         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Default Value | Run CdkDeploy When Changed |
|-------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------|----------------------------|
| sleeper.ingest.max.concurrent.tasks                   | The maximum number of concurrent ECS tasks to run.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 200           | false                      |
| sleeper.ingest.task.creation.period.minutes           | The frequency in minutes with which an EventBridge rule runs to trigger a lambda that, if necessary, runs more ECS tasks to perform ingest jobs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 1             | true                       |
| sleeper.ingest.keepalive.period.seconds               | The frequency, in seconds, with which change message visibility requests are sent to extend the visibility of messages on the ingest queue so that they are not processed by other processes.<br>This should be less than the value of sleeper.ingest.queue.visibility.timeout.seconds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 300           | false                      |
| sleeper.ingest.queue.visibility.timeout.seconds       | The visibility timeout in seconds for the standard ingest job queue. This should be greater than sleeper.ingest.keepalive.period.seconds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 900           | true                       |
| sleeper.ingest.fs.s3a.experimental.input.fadvise      | This sets the value of fs.s3a.experimental.input.fadvise on the Hadoop configuration used to read and write files to and from S3 in ingest jobs. Changing this value allows you to fine-tune how files are read. Possible values are "normal", "sequential" and "random". More information is available here:<br>https://hadoop.apache.org/docs/current/hadoop-aws/tools/hadoop-aws/performance.html#fadvise.                                                                                                                                                                                                                                                                                                                                                                                                    | sequential    | false                      |
| sleeper.ingest.task.cpu                               | The amount of CPU used by Fargate tasks that perform ingest jobs.<br>Note that only certain combinations of CPU and memory are valid.<br>See https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html for valid options.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 2048          | true                       |
| sleeper.ingest.task.memory.mb                         | The amount of memory in MB used by Fargate tasks that perform ingest jobs.<br>Note that only certain combinations of CPU and memory are valid.<br>See https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-cpu-memory-error.html for valid options.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | 4096          | true                       |
| sleeper.ingest.partition.refresh.period               | The frequency in seconds with which ingest tasks refresh their view of the partitions.<br>(NB Refreshes only happen once a batch of data has been written so this is a lower bound on the refresh frequency.)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 120           | false                      |
| sleeper.ingest.source.bucket                          | A comma-separated list of buckets that contain files to be ingested via ingest jobs. The buckets should already exist, i.e. they will not be created as part of the cdk deployment of this instance of Sleeper. The ingest and bulk import stacks will be given read access to these buckets so that they can consume data from them.                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |               | true                       |
| sleeper.ingest.tracker.enabled                        | Flag to enable/disable storage of tracking information for ingest jobs and tasks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | true          | true                       |
| sleeper.ingest.job.status.ttl                         | The time to live in seconds for ingest job updates in the job tracker. Default is 1 week.<br>The expiry time is fixed when an update is saved to the store, so changing this will only affect new data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 604800        | false                      |
| sleeper.ingest.task.status.ttl                        | The time to live in seconds for ingest task updates in the job tracker. Default is 1 week.<br>The expiry time is fixed when an update is saved to the store, so changing this will only affect new data.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 604800        | false                      |
| sleeper.ingest.job.queue.wait.time                    | The time in seconds to wait for ingest jobs to appear on the queue before an ingest task terminates.<br>Must be >= 0 and <= 20.<br>See also https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-short-and-long-polling.html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 20            | false                      |
| sleeper.ingest.max.local.records                      | The maximum number of records written to local file in an ingest job. (Records are written in sorted order to local disk before being uploaded to S3. Increasing this value increases the amount of time before data is visible in the system, but increases the number of records written to S3 in a batch, therefore reducing costs.)<br>(arraylist-based ingest only)                                                                                                                                                                                                                                                                                                                                                                                                                                         | 100000000     | false                      |
| sleeper.ingest.memory.max.batch.size                  | The maximum number of records to read into memory in an ingest job. (Up to sleeper.ingest.memory.max.batch.size records are read into memory before being sorted and written to disk. This process is repeated until sleeper.ingest.max.local.records records have been written to local files. Then the sorted files and merged and the data is written to sorted files in S3.)<br>(arraylist-based ingest only)                                                                                                                                                                                                                                                                                                                                                                                                | 1000000       | false                      |
| sleeper.ingest.arrow.working.buffer.bytes             | The number of bytes to allocate to the Arrow working buffer. This buffer is used for sorting and other sundry activities. Note that this is off-heap memory, which is in addition to the memory assigned to the JVM.<br>(arrow-based ingest only) [256MB]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | 268435456     | false                      |
| sleeper.ingest.arrow.batch.buffer.bytes               | The number of bytes to allocate to the Arrow batch buffer, which is used to hold the records before they are written to local disk. A larger value means that the local disk holds fewer, larger files, which are more efficient to merge together during an upload to S3. Larger values may require a larger working buffer. Note that this is off-heap memory, which is in addition to the memory assigned to the JVM.<br>(arrow-based ingest only) [1GB]                                                                                                                                                                                                                                                                                                                                                      | 1073741824    | false                      |
| sleeper.ingest.arrow.max.local.store.bytes            | The maximum number of bytes to store on the local disk before uploading to the main Sleeper store. A larger value reduces the number of S3 PUTs that are required to upload thle data to S3 and results in fewer files per partition.<br>(arrow-based ingest only) [2GB]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 2147483648    | false                      |
| sleeper.ingest.arrow.max.single.write.to.file.records | The number of records to write at once into an Arrow file in the local store. A single Arrow file contains many of these micro-batches and so this parameter does not significantly affect the final size of the Arrow file. Larger values may require a larger working buffer.<br>(arrow-based ingest only) [1K]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 1024          | false                      |
| sleeper.ingest.async.client.type                      | The implementation of the async S3 client to use for upload during ingest.<br>Valid values are 'java' or 'crt'. This determines the implementation of S3AsyncClient that gets used.<br>With 'java' it makes a single PutObject request for each file.<br>With 'crt' it uses the AWS Common Runtime (CRT) to make multipart uploads.<br>Note that the CRT option is recommended. Using the Java option may cause failures if any file is >5GB in size, and will lead to the following warning:<br>"The provided S3AsyncClient is not an instance of S3CrtAsyncClient, and thus multipart upload/download feature is not enabled and resumable file upload is not supported. To benefit from maximum throughput, consider using S3AsyncClient.crtBuilder().build() instead."<br>(async partition file writer only) | crt           | false                      |
| sleeper.ingest.async.crt.part.size.bytes              | The part size in bytes to use for multipart uploads.<br>(CRT async ingest only) [128MB]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 134217728     | false                      |
| sleeper.ingest.async.crt.target.throughput.gbps       | The target throughput for multipart uploads, in GB/s. Determines how many parts should be uploaded simultaneously.<br>(CRT async ingest only)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 10            | false                      |
| sleeper.ingest.batcher.submitter.memory.mb            | The amount of memory in MB for the lambda that receives submitted requests to ingest files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | 1024          | true                       |
| sleeper.ingest.batcher.submitter.timeout.seconds      | The timeout in seconds for the lambda that receives submitted requests to ingest files. Also used to define the visibility timeout for the batcher submit queue.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | 20            | true                       |
| sleeper.ingest.batcher.job.creation.memory.mb         | The amount of memory in MB for the lambda that creates ingest jobs from submitted file ingest requests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | 1024          | true                       |
| sleeper.ingest.batcher.job.creation.timeout.seconds   | The timeout in seconds for the lambda that creates ingest jobs from submitted file ingest requests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 900           | true                       |
| sleeper.ingest.batcher.job.creation.period.minutes    | The rate at which the ingest batcher job creation lambda runs (in minutes, must be >=1).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | 1             | true                       |
