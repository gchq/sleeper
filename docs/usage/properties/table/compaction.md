## Table Properties - Compaction

The following table properties relate to compactions.

| Property Name                                                                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Default Value                                                                  |
|-------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|
| sleeper.table.compaction.strategy.class                                       | The name of the class that defines how compaction jobs should be created.<br>This should implement sleeper.compaction.strategy.CompactionStrategy. Defaults to the strategy used by the whole instance (set in the instance properties).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | sleeper.compaction.core.job.creation.strategy.impl.SizeRatioCompactionStrategy |
| sleeper.table.compaction.files.batch.size                                     | The maximum number of files to read in a compaction job. Note that the state store must support atomic updates for this many files.<br>Also note that this many files may need to be open simultaneously. The value of 'sleeper.fs.s3a.max-connections' must be at least the value of this plus one. The extra one is for the output file.                                                                                                                                                                                                                                                                                                                                                                                                                              | 12                                                                             |
| sleeper.table.compaction.job.creation.limit                                   | The maximum number of compaction jobs that can be running at once. When creating new jobs, if this limit is exceeded, the selection of jobs is randomised.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | 100000                                                                         |
| sleeper.table.compaction.job.send.batch.size                                  | The number of compaction jobs to send in a single batch.<br>When compaction jobs are created, there is no limit on how many jobs can be created at once. A batch is a group of compaction jobs that will have their creation updates applied at the same time. For each batch, we send all compaction jobs to the SQS queue, then update the state store to assign job IDs to the input files.                                                                                                                                                                                                                                                                                                                                                                          | 1000                                                                           |
| sleeper.table.compaction.job.send.timeout.seconds                             | The amount of time in seconds a batch of compaction jobs may be pending before it should not be retried. If the input files have not been successfully assigned to the jobs, and this much time has passed, then the batch will fail to send.<br>Once a pending batch fails the input files will never be compacted again without other intervention, so it's important to ensure file assignment will be done within this time. That depends on the throughput of state store commits.<br>It's also necessary to ensure file assignment will be done before the next invocation of compaction job creation, otherwise invalid jobs will be created for the same input files. The rate of these invocations is set in `sleeper.compaction.job.creation.period.minutes`. | 90                                                                             |
| sleeper.table.compaction.job.send.retry.delay.seconds                         | The amount of time in seconds to wait between attempts to send a batch of compaction jobs. The batch will be sent if all input files have been successfully assigned to the jobs, otherwise the batch will be retried after a delay.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | 30                                                                             |
| sleeper.table.compaction.job.id.assignment.commit.async                       | If true, compaction job ID assignment commit requests will be sent to the state store committer lambda to be performed asynchronously. If false, compaction job ID assignments will be committed synchronously by the compaction job creation lambda.<br>This is only applied if async commits are enabled for the table. The default value is set in an instance property.                                                                                                                                                                                                                                                                                                                                                                                             | true                                                                           |
| sleeper.table.compaction.job.commit.async                                     | If true, compaction job commit requests will be sent to the state store committer lambda to be performed asynchronously. If false, compaction jobs will be committed synchronously by compaction tasks.<br>This is only applied if async commits are enabled for the table. The default value is set in an instance property.                                                                                                                                                                                                                                                                                                                                                                                                                                           | true                                                                           |
| sleeper.table.compaction.job.async.commit.batching                            | This property affects whether commits of compaction jobs are batched before being sent to the state store commit queue to be applied by the committer lambda. If this property is true and asynchronous commits are enabled then commits of compactions will be batched. If this property is false and asynchronous commits are enabled then commits of compactions will not be batched and will be sent directly to the committer lambda.                                                                                                                                                                                                                                                                                                                              | true                                                                           |
| sleeper.table.compaction.strategy.sizeratio.ratio                             | Used by the SizeRatioCompactionStrategy to decide if a group of files should be compacted.<br>If the file sizes are s_1, ..., s_n then the files are compacted if s_1 + ... + s_{n-1} >= ratio * s_n.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 3                                                                              |
| sleeper.table.compaction.strategy.sizeratio.max.concurrent.jobs.per.partition | Used by the SizeRatioCompactionStrategy to control the maximum number of jobs that can be running concurrently per partition.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | 2147483647                                                                     |
| sleeper.table.compaction.method                                               | Select which compaction method to use for the table. DataFusion compaction support is experimental.<br>Valid values are: [java, datafusion]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | JAVA                                                                           |
